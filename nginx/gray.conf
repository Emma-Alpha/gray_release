# 模版配置文件

# ===== 在 server 块外部定义 map =====

# auth 返回的 upstream 映射
map $gray_upstream_var $final_backend {
    ""      "http://127.0.0.1:8228";
    default $gray_upstream_var;
}

# cookie 中存储的后端地址映射（用于静态资源）
map $cookie_gray_backend $static_backend {
    ""      "http://127.0.0.1:8228";
    default $cookie_gray_backend;
}

server {
    server_name dev-ai-local-aigame.gz4399.com;
    listen 443;
    listen 80;
    include ssl2.conf;

    resolver 8.8.8.8 valid=30s ipv6=off;

    # ========== 灰度决策内部接口 ==========
    location = /_gray_auth {
        internal;
        proxy_pass http://127.0.0.1:8001/api/gray/auth;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-User-Id $cookie_username;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Cookie $http_cookie;
        proxy_connect_timeout 1s;
        proxy_read_timeout 1s;
    }

    # ========== 静态资源（用 cookie，不调用 auth）==========
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map|json|webp|mp3|mp4|webm)$ {
        # ✅ 添加 CORS 头 - 解决跨域问题
        add_header Access-Control-Allow-Origin "https://dev-ai-local.gz4399.com" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, HEAD" always;
        add_header Access-Control-Allow-Headers "*" always;
        add_header Access-Control-Allow-Credentials "true" always;

        # 处理 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "https://dev-ai-local.gz4399.com" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, HEAD" always;
            add_header Access-Control-Allow-Headers "*" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        proxy_pass $static_backend;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_http_version 1.1;

        add_header X-Gray-Source "cookie" always;
        add_header X-Gray-Backend $static_backend always;
    }

    # ========== HTML 入口（调用 auth，设置 cookie）==========
    location = / {
        auth_request /_gray_auth;
        auth_request_set $gray_upstream_var $upstream_http_x_gray_upstream;
        auth_request_set $gray_target $upstream_http_x_gray_target;

        # 设置 cookie 供后续静态资源使用（5分钟有效期）
        add_header Set-Cookie "gray_backend=$final_backend; Path=/; Max-Age=300" always;

        add_header Access-Control-Allow-Origin "https://dev-ai-local.gz4399.com" always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass $final_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 150;

        add_header X-Gray-Source "auth" always;
        add_header X-Gray-Target $gray_target always;
        add_header X-Gray-Backend $final_backend always;
    }

    # ========== 其他路径 - SPA 路由等（调用 auth）==========
    location / {
        auth_request /_gray_auth;
        auth_request_set $gray_upstream_var $upstream_http_x_gray_upstream;
        auth_request_set $gray_target $upstream_http_x_gray_target;

        # 设置 cookie
        add_header Set-Cookie "gray_backend=$final_backend; Path=/; Max-Age=300" always;

        add_header Access-Control-Allow-Origin "https://dev-ai-local.gz4399.com" always;
        add_header Access-Control-Allow-Credentials "true" always;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass $final_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 150;

        add_header X-Gray-Source "auth" always;
        add_header X-Gray-Target $gray_target always;
        add_header X-Gray-Backend $final_backend always;
    }

    # ========== 其他固定 location ==========
    location ^~ /images/ {
        proxy_pass http://127.0.0.1:8228/images/;
    }

    location ^~ /minio/support/ {
        proxy_pass https://4399-ywkf-cmdb-log-1252003912.cos.ap-guangzhou.myqcloud.com/apps-support/chat_storage/;
    }

    location ^~ /assets/downloads/ {
        alias /Users/liangpingbo/Downloads/;
    }

    location ^~ /api {
        proxy_set_header Host dev-ai.gz4399.com;
        proxy_redirect off;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_pass http://81.71.82.38/api;
    }

    location ^~ /cosres/ {
        proxy_pass https://dev-ai.gz4399.com/cosres/;
    }
}
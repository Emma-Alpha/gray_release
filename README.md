# ğŸ¯ å‰ç«¯ç°åº¦å‘å¸ƒç®¡ç†ç³»ç»Ÿ

ä¸€ä¸ªåŸºäº **Nginx + Python BFF + React** çš„å‰ç«¯ç°åº¦å‘å¸ƒç³»ç»Ÿï¼Œæ”¯æŒç™½åå•æ–¹å¼ç°åº¦ï¼Œå°†å†³ç­–æƒä¸‹æ”¾åˆ° BFF å±‚å®ç°çµæ´»æ§åˆ¶ã€‚

## ğŸ“ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·è¯·æ±‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Nginx (æµé‡ç½‘å…³)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  auth_request /_gray_auth  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚                                                   â”‚  â”‚   â”‚
â”‚  â”‚  æ ¹æ® X-Gray-Target å“åº”å¤´å†³å®šè·¯ç”±:                  â”‚  â”‚   â”‚
â”‚  â”‚  â€¢ gray   â†’ ç°åº¦ç‰ˆæœ¬æœåŠ¡                           â”‚  â”‚   â”‚
â”‚  â”‚  â€¢ stable â†’ ç¨³å®šç‰ˆæœ¬æœåŠ¡                           â”‚  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                      â”‚
           â–¼                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Python BFF      â”‚                   â”‚  å‰ç«¯æœåŠ¡         â”‚
â”‚  (ç°åº¦å†³ç­–)       â”‚                   â”‚  (stable/gray)   â”‚
â”‚                  â”‚                   â”‚                  â”‚
â”‚  â€¢ ç™½åå•åŒ¹é…     â”‚                   â”‚                  â”‚
â”‚  â€¢ Header åŒ¹é…   â”‚                   â”‚                  â”‚
â”‚  â€¢ Cookie åŒ¹é…   â”‚                   â”‚                  â”‚
â”‚  â€¢ IP åŒ¹é…       â”‚                   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SQLite æ•°æ®åº“    â”‚
â”‚  (è§„åˆ™é…ç½®å­˜å‚¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **ğŸ”€ çµæ´»çš„ç°åº¦ç­–ç•¥**: æ”¯æŒç™½åå•ã€Headerã€Cookieã€IP å¤šç§åŒ¹é…æ–¹å¼
- **âš¡ é«˜æ€§èƒ½å†³ç­–**: BFF æ¯«ç§’çº§å“åº”ï¼Œæ”¯æŒç¼“å­˜ä¼˜åŒ–
- **ğŸ¨ å¯è§†åŒ–ç®¡ç†**: React + Antd æ‰“é€ çš„ç°ä»£åŒ–ç®¡ç†ç•Œé¢
- **ğŸ“ è§„åˆ™ä¼˜å…ˆçº§**: å¤šè§„åˆ™æŒ‰ä¼˜å…ˆçº§é¡ºåºåŒ¹é…
- **ğŸ”Œ Nginx é›†æˆ**: ä½¿ç”¨ auth_request æ¨¡å—ï¼Œæ— ä¾µå…¥å¼é›†æˆ
- **ğŸ“¦ å¼€ç®±å³ç”¨**: Docker Compose ä¸€é”®éƒ¨ç½²

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¯åŠ¨æœåŠ¡
python -m uvicorn app.main:app --reload --port 8000
```

åç«¯ API æ–‡æ¡£: http://localhost:8000/docs

### 2. å¯åŠ¨å‰ç«¯ç®¡ç†ç•Œé¢

```bash
cd frontend

# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

ç®¡ç†ç•Œé¢: http://localhost:5173

### 3. é…ç½® Nginx (å¯é€‰)

å‚è€ƒ `nginx/gray.conf` é…ç½®æ–‡ä»¶ï¼Œæ ¸å¿ƒé…ç½®ï¼š

```nginx
# å†…éƒ¨ç°åº¦å†³ç­–æ¥å£
location = /_gray_auth {
    internal;
    proxy_pass http://bff_backend/gray/auth;
    proxy_set_header X-User-Id $http_x_user_id;
    proxy_set_header X-Real-IP $remote_addr;
}

# ä¸»å…¥å£
location / {
    auth_request /_gray_auth;
    auth_request_set $gray_target $upstream_http_x_gray_target;
    
    # æ ¹æ®å†³ç­–è·¯ç”±
    set $backend stable_backend;
    if ($gray_target = "gray") {
        set $backend gray_backend;
    }
    
    proxy_pass http://$backend;
}
```

## ğŸ“š API æ–‡æ¡£

### ç°åº¦å†³ç­–æ¥å£

#### POST /gray/decide
æ‰‹åŠ¨è°ƒç”¨ç°åº¦å†³ç­–

```json
{
  "user_id": "user123",
  "ip": "192.168.1.100",
  "headers": {"X-Custom": "value"},
  "cookies": {"session": "abc"}
}
```

å“åº”ï¼š
```json
{
  "should_gray": true,
  "target_version": "gray",
  "matched_rule": "å†…æµ‹ç”¨æˆ·",
  "reason": "Matched rule: å†…æµ‹ç”¨æˆ· (whitelist)"
}
```

#### GET /gray/auth
Nginx auth_request ä¸“ç”¨æ¥å£ï¼Œé€šè¿‡å“åº”å¤´è¿”å›å†³ç­–ç»“æœï¼š
- `X-Gray-Target`: gray / stable
- `X-Gray-Upstream`: ç›®æ ‡ä¸Šæ¸¸åœ°å€
- `X-Gray-Matched`: åŒ¹é…çš„è§„åˆ™å

### ç®¡ç†æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /admin/rules | è·å–è§„åˆ™åˆ—è¡¨ |
| POST | /admin/rules | åˆ›å»ºè§„åˆ™ |
| PUT | /admin/rules/{id} | æ›´æ–°è§„åˆ™ |
| DELETE | /admin/rules/{id} | åˆ é™¤è§„åˆ™ |
| PATCH | /admin/rules/{id}/toggle | åˆ‡æ¢å¯ç”¨çŠ¶æ€ |
| GET | /admin/rules/{id}/whitelist | è·å–ç™½åå• |
| POST | /admin/whitelist | æ·»åŠ ç™½åå• |
| POST | /admin/whitelist/batch | æ‰¹é‡æ·»åŠ ç™½åå• |
| DELETE | /admin/whitelist/{id} | åˆ é™¤ç™½åå•æ¡ç›® |

## ğŸ”§ é…ç½®è¯´æ˜

### ç°åº¦è§„åˆ™å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| name | string | è§„åˆ™åç§°ï¼ˆå”¯ä¸€ï¼‰ |
| description | string | è§„åˆ™æè¿° |
| is_enabled | boolean | æ˜¯å¦å¯ç”¨ |
| priority | number | ä¼˜å…ˆçº§ï¼ˆè¶Šå¤§è¶Šä¼˜å…ˆï¼‰ |
| match_type | string | åŒ¹é…ç±»å‹: whitelist/header/cookie/ip |
| match_key | string | åŒ¹é…é”®åï¼ˆheader/cookieç±»å‹éœ€è¦ï¼‰ |
| match_values | string[] | åŒ¹é…å€¼åˆ—è¡¨ |
| target_version | string | ç›®æ ‡ç‰ˆæœ¬æ ‡è¯† |
| target_upstream | string | ç›®æ ‡ä¸Šæ¸¸åœ°å€ |

### åŒ¹é…ç±»å‹è¯´æ˜

1. **whitelist (ç™½åå•)**: æ ¹æ®ç”¨æˆ·IDæˆ–IPåŒ¹é…ç™½åå•åˆ—è¡¨
2. **header**: åŒ¹é…è¯·æ±‚å¤´çš„ç‰¹å®šå€¼
3. **cookie**: åŒ¹é…Cookieçš„ç‰¹å®šå€¼  
4. **ip**: ç›´æ¥åŒ¹é…IPåœ°å€

## ğŸ³ Docker éƒ¨ç½²

```bash
cd nginx
docker-compose -f docker-compose.example.yml up -d
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
gray_release/
â”œâ”€â”€ backend/                # Python BFF æœåŠ¡
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ main.py        # FastAPI å…¥å£
â”‚   â”‚   â”œâ”€â”€ models.py      # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”‚   â”œâ”€â”€ gray.py    # ç°åº¦å†³ç­– API
â”‚   â”‚   â”‚   â””â”€â”€ admin.py   # ç®¡ç† API
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â””â”€â”€ gray_service.py  # å†³ç­–é€»è¾‘
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ frontend/              # React ç®¡ç†ç•Œé¢
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.tsx       # ä¸»åº”ç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ api.ts        # API å°è£…
â”‚   â”‚   â””â”€â”€ index.css     # å…¨å±€æ ·å¼
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ nginx/                 # Nginx é…ç½®
â”‚   â”œâ”€â”€ gray.conf         # ç°åº¦é…ç½®ç¤ºä¾‹
â”‚   â””â”€â”€ docker-compose.example.yml
â”‚
â””â”€â”€ README.md
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **ç°åº¦é¡ºåº**: å»ºè®®æŒ‰ å†…æµ‹â†’å°æµé‡â†’å…¨é‡ çš„é¡ºåºé€æ­¥æ”¾å¼€
2. **è§„åˆ™ä¼˜å…ˆçº§**: ç²¾ç¡®åŒ¹é…çš„è§„åˆ™åº”è®¾ç½®æ›´é«˜ä¼˜å…ˆçº§
3. **ç›‘æ§å‘Šè­¦**: å…³æ³¨ç°åº¦ç‰ˆæœ¬çš„é”™è¯¯ç‡å’Œæ€§èƒ½æŒ‡æ ‡
4. **å¿«é€Ÿå›æ»š**: é€šè¿‡ç¦ç”¨è§„åˆ™å¯å®ç°ç§’çº§å›æ»š
5. **ç¼“å­˜ç­–ç•¥**: é«˜å¹¶å‘åœºæ™¯å¯åœ¨ Nginx å±‚ç¼“å­˜å†³ç­–ç»“æœ

## ğŸ¤ æŠ€æœ¯æ ˆ

- **åç«¯**: Python 3.11 + FastAPI + SQLAlchemy + SQLite
- **å‰ç«¯**: React 18 + TypeScript + Antd 5 + Vite
- **ç½‘å…³**: Nginx + auth_request æ¨¡å—

## ğŸ“„ License

MIT

